name: Deploy ETL Lambda and ECR

on:
    push:
        branches:
            - main
permissions:
    id-token: write
    contents: read

jobs:
    build_ecr:
        runs-on: ubuntu-latest
        env:
            AWS_DEFAULT_REGION: us-east-1
        defaults:
            run:
              shell: bash

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.10.0

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ secrets.AWS_OIDC_ARN }}
                role-session-name: GitHub_to_AWS_via_FederatedOIDC
                aws-region: ${{ env.AWS_DEFAULT_REGION }}

            - name: Set Image Target
              id: set_image_tag
              run: |
                  IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
                  echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
                  echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

            - name: Terraform ECR Init
              run: |
                  cd ecr-module &&
                  terraform init

            - name: Terraform ECR Apply
              run: |
                  cd ecr-module &&
                  terraform apply -auto-approve

            - name: GET ECR URI
              id: get_image_uri
              run: |
                  IMAGE_URI=$(cd ecr-module && terraform output -raw ecr_repository_url)
                  echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
                  echo "O valor de image_uri Ã©: $IMAGE_URI"
